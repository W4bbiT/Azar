/**
 * Copyright (c) 2015 NAVER Corp.
 * egjs projects are licensed under the MIT license
 */
import { Component, Input, Output, EventEmitter, ViewEncapsulation, ContentChildren, HostBinding, Inject, PLATFORM_ID, } from '@angular/core';
import { CommonModule, isPlatformBrowser } from '@angular/common';
import { fromEvent, Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import VanillaFlicking, { sync, getDefaultCameraTransform, VirtualRenderingStrategy, NormalRenderingStrategy, range, CLASS, } from '@egjs/flicking';
import ListDiffer from '@egjs/list-differ';
import { EVENT_NAMES } from './consts';
import FlickingInterface from './FlickingInterface';
import { NgxFlickingPanel } from './ngx-flicking-panel.directive';
import NgxRenderer from './NgxRenderer';
import NgxElementProvider from './NgxElementProvider';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export class NgxFlickingComponent extends FlickingInterface {
    get isVertical() {
        return this.options.horizontal === false;
    }
    get isHiddenBeforeInit() {
        const initialized = this._vanillaFlicking && this._vanillaFlicking.initialized;
        return this.hideBeforeInit && !initialized;
    }
    get cameraStyleBeforeInit() {
        const initialized = this._vanillaFlicking && this._vanillaFlicking.initialized;
        return !initialized && this.firstPanelSize
            ? { transform: getDefaultCameraTransform(this.options.align, this.options.horizontal, this.firstPanelSize) }
            : {};
    }
    get ngxPanels() { return this._ngxPanels; }
    // eslint-disable-next-line @typescript-eslint/naming-convention
    get _cameraElClass() { return `flicking-camera ${this.cameraClass ?? ""}`.trim(); }
    constructor(_elRef, _ngxRenderer, _platformId, _ngZone) {
        super();
        this._elRef = _elRef;
        this._ngxRenderer = _ngxRenderer;
        this._platformId = _platformId;
        this._ngZone = _ngZone;
        this.options = {};
        this.plugins = [];
        this.hideBeforeInit = false;
        this._pluginsDiffer = new ListDiffer();
        this._destroy$ = new Subject();
        this._vanillaFlicking = null;
        EVENT_NAMES.forEach(evtName => {
            this[evtName] = new EventEmitter();
        });
    }
    ngAfterViewInit() {
        if (!isPlatformBrowser(this._platformId))
            return;
        const options = this.options;
        const viewportEl = this._elRef.nativeElement;
        const virtual = options.virtual && options.panelsPerView > 0;
        const rendererOptions = {
            ngxFlicking: this,
            align: options.align,
            ngxRenderer: this._ngxRenderer,
            strategy: virtual
                ? new VirtualRenderingStrategy()
                : new NormalRenderingStrategy({
                    providerCtor: NgxElementProvider
                })
        };
        if (virtual) {
            this._initVirtualElements();
        }
        // Initialize `VanillaFlicking` outside of the Angular zone so it will set up `mousedown`
        // and `mousemove` event listeners within the root zone, and it won't trigger change detection
        // every time the user moves the mouse.
        const flicking = this._ngZone.runOutsideAngular(() => new VanillaFlicking(viewportEl, {
            ...this.options,
            externalRenderer: new NgxRenderer(rendererOptions)
        }));
        this._vanillaFlicking = flicking;
        const elementDiffer = new ListDiffer(this._ngxPanels.toArray());
        this._bindEvents();
        this._checkPlugins();
        if (this.status) {
            flicking.setStatus(this.status);
        }
        // Note: doesn't need to unsubscribe, because `changes`
        // gets completed by Angular when the view is destroyed.
        this._ngxPanels.changes.subscribe(() => {
            const panels = this._ngxPanels.toArray();
            const diffResult = elementDiffer.update(panels);
            // eslint-disable-next-line @typescript-eslint/no-unused-vars
            sync(flicking, diffResult, [...diffResult.maintained.map(([_, idx]) => diffResult.list[idx]), ...diffResult.added.map(idx => diffResult.list[idx])]);
        });
    }
    ngOnDestroy() {
        this._destroy$.next();
        this._vanillaFlicking?.destroy();
    }
    ngOnChanges() {
        const flicking = this._vanillaFlicking;
        if (!flicking)
            return;
        this._ngZone.runOutsideAngular(() => {
            void flicking.renderer.forceRenderAllPanels();
        });
        // eslint-disable-next-line @typescript-eslint/no-unused-vars
        const { virtual, ...newOptions } = this.options;
        // Omit 'virtual', as it can't have any setter
        for (const key in newOptions) {
            if (key in flicking && flicking[key] !== newOptions[key]) {
                flicking[key] = newOptions[key];
            }
        }
        this._checkPlugins();
    }
    _bindEvents() {
        const flicking = this._vanillaFlicking;
        EVENT_NAMES.forEach(evtName => {
            // `fromEvent` supports passing `JQueryStyleEventEmitter`
            // (an object with `on` and `off` methods). `flicking` acts as a
            // jQuery event emitter since it has both methods.
            fromEvent(flicking, evtName)
                .pipe(takeUntil(this._destroy$))
                .subscribe((e) => {
                // Style guide: Event - https://angular.io/guide/styleguide#dont-prefix-output-properties
                const emitter = this[evtName];
                e.currentTarget = this;
                if (emitter && emitter.observers.length > 0) {
                    this._ngZone.run(() => emitter.emit(e));
                }
            });
        });
    }
    _checkPlugins() {
        const flicking = this._vanillaFlicking;
        if (!flicking)
            return;
        const { list, added, removed, prevList } = this._pluginsDiffer.update(this.plugins);
        flicking.addPlugins(...added.map(index => list[index]));
        flicking.removePlugins(...removed.map(index => prevList[index]));
    }
    _initVirtualElements() {
        const options = this.options;
        const renderer = this._ngxRenderer;
        const cameraElement = this._elRef.nativeElement.firstElementChild;
        const panelsPerView = options.panelsPerView;
        const virtual = options.virtual;
        const fragment = document.createDocumentFragment();
        const newElements = range(panelsPerView + 1).map(idx => {
            const panelEl = renderer.createElement("div");
            panelEl.className = virtual.panelClass ?? CLASS.DEFAULT_VIRTUAL;
            panelEl.dataset.elementIndex = idx.toString();
            return panelEl;
        });
        newElements.forEach(el => {
            fragment.appendChild(el);
        });
        renderer.appendChild(cameraElement, fragment);
    }
}
NgxFlickingComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.2", ngImport: i0, type: NgxFlickingComponent, deps: [{ token: i0.ElementRef }, { token: i0.Renderer2 }, { token: PLATFORM_ID }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Component });
NgxFlickingComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.2", type: NgxFlickingComponent, isStandalone: true, selector: "ngx-flicking, [NgxFlicking]", inputs: { options: "options", plugins: "plugins", status: "status", cameraClass: "cameraClass", hideBeforeInit: "hideBeforeInit", firstPanelSize: "firstPanelSize" }, outputs: { ready: "ready", beforeResize: "beforeResize", afterResize: "afterResize", holdStart: "holdStart", holdEnd: "holdEnd", moveStart: "moveStart", move: "move", moveEnd: "moveEnd", willChange: "willChange", changed: "changed", willRestore: "willRestore", restored: "restored", select: "select", needPanel: "needPanel", visibleChange: "visibleChange", reachEdge: "reachEdge", panelChange: "panelChange" }, host: { properties: { "class.vertical": "this.isVertical", "class.flicking-hidden": "this.isHiddenBeforeInit" }, styleAttribute: "display: block;", classAttribute: "flicking-viewport" }, queries: [{ propertyName: "_ngxPanels", predicate: NgxFlickingPanel }], usesInheritance: true, usesOnChanges: true, ngImport: i0, template: `
    <div [ngClass]="_cameraElClass" [ngStyle]="cameraStyleBeforeInit">
      <ng-content></ng-content>
    </div>
    <ng-content select="[in-viewport]"></ng-content>`, isInline: true, styles: [".flicking-viewport{position:relative;overflow:hidden}.flicking-viewport.vertical{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.flicking-viewport.vertical>.flicking-camera{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}.flicking-viewport.flicking-hidden>.flicking-camera>*{visibility:hidden}.flicking-camera{width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;position:relative;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;z-index:1;will-change:transform}.flicking-camera>*{-ms-flex-negative:0;flex-shrink:0}\n"], dependencies: [{ kind: "ngmodule", type: CommonModule }, { kind: "directive", type: i1.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i1.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }], encapsulation: i0.ViewEncapsulation.None });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.2", ngImport: i0, type: NgxFlickingComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ngx-flicking, [NgxFlicking]', template: `
    <div [ngClass]="_cameraElClass" [ngStyle]="cameraStyleBeforeInit">
      <ng-content></ng-content>
    </div>
    <ng-content select="[in-viewport]"></ng-content>`, host: {
                        class: 'flicking-viewport',
                        style: 'display: block;',
                    }, encapsulation: ViewEncapsulation.None, standalone: true, imports: [CommonModule], styles: [".flicking-viewport{position:relative;overflow:hidden}.flicking-viewport.vertical{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.flicking-viewport.vertical>.flicking-camera{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}.flicking-viewport.flicking-hidden>.flicking-camera>*{visibility:hidden}.flicking-camera{width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;position:relative;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;z-index:1;will-change:transform}.flicking-camera>*{-ms-flex-negative:0;flex-shrink:0}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.Renderer2 }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: i0.NgZone }]; }, propDecorators: { options: [{
                type: Input
            }], plugins: [{
                type: Input
            }], status: [{
                type: Input
            }], cameraClass: [{
                type: Input
            }], hideBeforeInit: [{
                type: Input
            }], firstPanelSize: [{
                type: Input
            }], ready: [{
                type: Output
            }], beforeResize: [{
                type: Output
            }], afterResize: [{
                type: Output
            }], holdStart: [{
                type: Output
            }], holdEnd: [{
                type: Output
            }], moveStart: [{
                type: Output
            }], move: [{
                type: Output
            }], moveEnd: [{
                type: Output
            }], willChange: [{
                type: Output
            }], changed: [{
                type: Output
            }], willRestore: [{
                type: Output
            }], restored: [{
                type: Output
            }], select: [{
                type: Output
            }], needPanel: [{
                type: Output
            }], visibleChange: [{
                type: Output
            }], reachEdge: [{
                type: Output
            }], panelChange: [{
                type: Output
            }], isVertical: [{
                type: HostBinding,
                args: ["class.vertical"]
            }], isHiddenBeforeInit: [{
                type: HostBinding,
                args: ["class.flicking-hidden"]
            }], _ngxPanels: [{
                type: ContentChildren,
                args: [NgxFlickingPanel]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWZsaWNraW5nLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1mbGlja2luZy9zcmMvbGliL25neC1mbGlja2luZy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBQ0gsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBSUwsTUFBTSxFQUNOLFlBQVksRUFFWixpQkFBaUIsRUFFakIsZUFBZSxFQUVmLFdBQVcsRUFDWCxNQUFNLEVBQ04sV0FBVyxHQUVaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxlQUFlLEVBQUUsRUFHdEIsSUFBSSxFQUNKLHlCQUF5QixFQW9CekIsd0JBQXdCLEVBQ3hCLHVCQUF1QixFQUN2QixLQUFLLEVBQ0wsS0FBSyxHQUNOLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxVQUFVLE1BQU0sbUJBQW1CLENBQUM7QUFHM0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN2QyxPQUFPLGlCQUFpQixNQUFNLHFCQUFxQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ2xFLE9BQU8sV0FBbUMsTUFBTSxlQUFlLENBQUM7QUFDaEUsT0FBTyxrQkFBa0IsTUFBTSxzQkFBc0IsQ0FBQzs7O0FBb0J0RCxNQUFNLE9BQU8sb0JBQ1gsU0FBUSxpQkFBaUI7SUEyQnpCLElBQTBDLFVBQVU7UUFDbEQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsS0FBSyxLQUFLLENBQUM7SUFDM0Ms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QkFBN0IsS0FBSztnQkFDVyxLQUFLO3NCQUFyQixNQUFNO2dCQUNVLFlBQVk7c0JBQTVCLE1BQU07Z0JBQ1UsV0FBVztzQkFBM0IsTUFBTTtnQkFDVSxTQUFTO3NCQUF6QixNQUFNO2dCQUNVLE9BQU87c0JBQXZCLE1BQU07Z0JBQ1UsU0FBUztzQkFBekIsTUFBTTtnQkFDVSxJQUFJO3NCQUFwQixNQUFNO2dCQUNVLE9BQU87c0JBQXZCLE1BQU07Z0JBQ1UsVUFBVTtzQkFBMUIsTUFBTTtnQkFDVSxPQUFPO3NCQUF2QixNQUFNO2dCQUNVLFdBQVc7c0JBQTNCLE1BQU07Z0JBQ1UsUUFBUTtzQkFBeEIsTUFBTTtnQkFDVSxNQUFNO3NCQUF0QixNQUFNO2dCQUNVLFNBQVM7c0JBQXpCLE1BQU07Z0JBQ1UsYUFBYTtzQkFBN0IsTUFBTTtnQkFDVSxTQUFTO3NCQUF6QixNQUFNO2dCQUNVLFdBQVc7c0JBQTNCLE1BQU07Z0JBRW1DLFVBQVU7c0JBQW5ELFdBQVc7dUJBQUMsZ0JBQWdCO2dCQUlvQixrQkFBa0I7c0JBQWxFLFdBQVc7dUJBQUMsdUJBQXVCO2dCQVlPLFVBQVU7c0JBQXBELGVBQWU7dUJBQUMsZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUgTkFWRVIgQ29ycC5cbiAqIGVnanMgcHJvamVjdHMgYXJlIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZVxuICovXG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBBZnRlclZpZXdJbml0LFxuICBFbGVtZW50UmVmLFxuICBPbkNoYW5nZXMsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBPbkRlc3Ryb3ksXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxuICBRdWVyeUxpc3QsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgUmVuZGVyZXIyLFxuICBIb3N0QmluZGluZyxcbiAgSW5qZWN0LFxuICBQTEFURk9STV9JRCxcbiAgTmdab25lLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbW1vbk1vZHVsZSwgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgVmFuaWxsYUZsaWNraW5nLCB7XG4gIEZsaWNraW5nT3B0aW9ucyxcbiAgRmxpY2tpbmdFdmVudHMsXG4gIHN5bmMsXG4gIGdldERlZmF1bHRDYW1lcmFUcmFuc2Zvcm0sXG4gIFBsdWdpbixcbiAgU3RhdHVzLFxuICBTZWxlY3RFdmVudCxcbiAgTmVlZFBhbmVsRXZlbnQsXG4gIFZpc2libGVDaGFuZ2VFdmVudCxcbiAgSG9sZFN0YXJ0RXZlbnQsXG4gIEhvbGRFbmRFdmVudCxcbiAgTW92ZVN0YXJ0RXZlbnQsXG4gIE1vdmVFdmVudCxcbiAgTW92ZUVuZEV2ZW50LFxuICBXaWxsQ2hhbmdlRXZlbnQsXG4gIENoYW5nZWRFdmVudCxcbiAgV2lsbFJlc3RvcmVFdmVudCxcbiAgUmVzdG9yZWRFdmVudCxcbiAgUmVhZHlFdmVudCxcbiAgQmVmb3JlUmVzaXplRXZlbnQsXG4gIEFmdGVyUmVzaXplRXZlbnQsXG4gIFJlYWNoRWRnZUV2ZW50LFxuICBQYW5lbENoYW5nZUV2ZW50LFxuICBWaXJ0dWFsUmVuZGVyaW5nU3RyYXRlZ3ksXG4gIE5vcm1hbFJlbmRlcmluZ1N0cmF0ZWd5LFxuICByYW5nZSxcbiAgQ0xBU1MsXG59IGZyb20gJ0BlZ2pzL2ZsaWNraW5nJztcbmltcG9ydCBMaXN0RGlmZmVyIGZyb20gJ0BlZ2pzL2xpc3QtZGlmZmVyJztcbmltcG9ydCB7IENvbXBvbmVudEV2ZW50IH0gZnJvbSAnQGVnanMvY29tcG9uZW50JztcblxuaW1wb3J0IHsgRVZFTlRfTkFNRVMgfSBmcm9tICcuL2NvbnN0cyc7XG5pbXBvcnQgRmxpY2tpbmdJbnRlcmZhY2UgZnJvbSAnLi9GbGlja2luZ0ludGVyZmFjZSc7XG5pbXBvcnQgeyBOZ3hGbGlja2luZ1BhbmVsIH0gZnJvbSAnLi9uZ3gtZmxpY2tpbmctcGFuZWwuZGlyZWN0aXZlJztcbmltcG9ydCBOZ3hSZW5kZXJlciwgeyBOZ3hSZW5kZXJlck9wdGlvbnMgfSBmcm9tICcuL05neFJlbmRlcmVyJztcbmltcG9ydCBOZ3hFbGVtZW50UHJvdmlkZXIgZnJvbSAnLi9OZ3hFbGVtZW50UHJvdmlkZXInO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3gtZmxpY2tpbmcsIFtOZ3hGbGlja2luZ10nLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxkaXYgW25nQ2xhc3NdPVwiX2NhbWVyYUVsQ2xhc3NcIiBbbmdTdHlsZV09XCJjYW1lcmFTdHlsZUJlZm9yZUluaXRcIj5cbiAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgICA8L2Rpdj5cbiAgICA8bmctY29udGVudCBzZWxlY3Q9XCJbaW4tdmlld3BvcnRdXCI+PC9uZy1jb250ZW50PmAsXG4gIGhvc3Q6IHtcbiAgICBjbGFzczogJ2ZsaWNraW5nLXZpZXdwb3J0JyxcbiAgICBzdHlsZTogJ2Rpc3BsYXk6IGJsb2NrOycsXG4gIH0sXG4gIHN0eWxlVXJsczogW1xuICAgIFwiLi4vLi4vbm9kZV9tb2R1bGVzL0BlZ2pzL2ZsaWNraW5nL2Rpc3QvZmxpY2tpbmcuY3NzXCJcbiAgXSxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgc3RhbmRhbG9uZTogdHJ1ZSxcbiAgaW1wb3J0czogW0NvbW1vbk1vZHVsZV0sXG59KVxuZXhwb3J0IGNsYXNzIE5neEZsaWNraW5nQ29tcG9uZW50XG4gIGV4dGVuZHMgRmxpY2tpbmdJbnRlcmZhY2VcbiAgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlc1xue1xuICBASW5wdXQoKSBwdWJsaWMgb3B0aW9uczogUGFydGlhbDxGbGlja2luZ09wdGlvbnM+ID0ge307XG4gIEBJbnB1dCgpIHB1YmxpYyBwbHVnaW5zOiBQbHVnaW5bXSA9IFtdO1xuICBASW5wdXQoKSBwdWJsaWMgc3RhdHVzOiBTdGF0dXM7XG4gIEBJbnB1dCgpIHB1YmxpYyBjYW1lcmFDbGFzczogc3RyaW5nO1xuICBASW5wdXQoKSBwdWJsaWMgaGlkZUJlZm9yZUluaXQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgQElucHV0KCkgcHVibGljIGZpcnN0UGFuZWxTaXplOiBzdHJpbmc7XG4gIEBPdXRwdXQoKSBwdWJsaWMgcmVhZHk6IEV2ZW50RW1pdHRlcjxSZWFkeUV2ZW50PE5neEZsaWNraW5nQ29tcG9uZW50Pj47XG4gIEBPdXRwdXQoKSBwdWJsaWMgYmVmb3JlUmVzaXplOiBFdmVudEVtaXR0ZXI8QmVmb3JlUmVzaXplRXZlbnQ8Tmd4RmxpY2tpbmdDb21wb25lbnQ+PjtcbiAgQE91dHB1dCgpIHB1YmxpYyBhZnRlclJlc2l6ZTogRXZlbnRFbWl0dGVyPEFmdGVyUmVzaXplRXZlbnQ8Tmd4RmxpY2tpbmdDb21wb25lbnQ+PjtcbiAgQE91dHB1dCgpIHB1YmxpYyBob2xkU3RhcnQ6IEV2ZW50RW1pdHRlcjxIb2xkU3RhcnRFdmVudDxOZ3hGbGlja2luZ0NvbXBvbmVudD4+O1xuICBAT3V0cHV0KCkgcHVibGljIGhvbGRFbmQ6IEV2ZW50RW1pdHRlcjxIb2xkRW5kRXZlbnQ8Tmd4RmxpY2tpbmdDb21wb25lbnQ+PjtcbiAgQE91dHB1dCgpIHB1YmxpYyBtb3ZlU3RhcnQ6IEV2ZW50RW1pdHRlcjxNb3ZlU3RhcnRFdmVudDxOZ3hGbGlja2luZ0NvbXBvbmVudD4+O1xuICBAT3V0cHV0KCkgcHVibGljIG1vdmU6IEV2ZW50RW1pdHRlcjxNb3ZlRXZlbnQ8Tmd4RmxpY2tpbmdDb21wb25lbnQ+PjtcbiAgQE91dHB1dCgpIHB1YmxpYyBtb3ZlRW5kOiBFdmVudEVtaXR0ZXI8TW92ZUVuZEV2ZW50PE5neEZsaWNraW5nQ29tcG9uZW50Pj47XG4gIEBPdXRwdXQoKSBwdWJsaWMgd2lsbENoYW5nZTogRXZlbnRFbWl0dGVyPFdpbGxDaGFuZ2VFdmVudDxOZ3hGbGlja2luZ0NvbXBvbmVudD4+O1xuICBAT3V0cHV0KCkgcHVibGljIGNoYW5nZWQ6IEV2ZW50RW1pdHRlcjxDaGFuZ2VkRXZlbnQ8Tmd4RmxpY2tpbmdDb21wb25lbnQ+PjtcbiAgQE91dHB1dCgpIHB1YmxpYyB3aWxsUmVzdG9yZTogRXZlbnRFbWl0dGVyPFdpbGxSZXN0b3JlRXZlbnQ8Tmd4RmxpY2tpbmdDb21wb25lbnQ+PjtcbiAgQE91dHB1dCgpIHB1YmxpYyByZXN0b3JlZDogRXZlbnRFbWl0dGVyPFJlc3RvcmVkRXZlbnQ8Tmd4RmxpY2tpbmdDb21wb25lbnQ+PjtcbiAgQE91dHB1dCgpIHB1YmxpYyBzZWxlY3Q6IEV2ZW50RW1pdHRlcjxTZWxlY3RFdmVudDxOZ3hGbGlja2luZ0NvbXBvbmVudD4+O1xuICBAT3V0cHV0KCkgcHVibGljIG5lZWRQYW5lbDogRXZlbnRFbWl0dGVyPE5lZWRQYW5lbEV2ZW50PE5neEZsaWNraW5nQ29tcG9uZW50Pj47XG4gIEBPdXRwdXQoKSBwdWJsaWMgdmlzaWJsZUNoYW5nZTogRXZlbnRFbWl0dGVyPFZpc2libGVDaGFuZ2VFdmVudDxOZ3hGbGlja2luZ0NvbXBvbmVudD4+O1xuICBAT3V0cHV0KCkgcHVibGljIHJlYWNoRWRnZTogRXZlbnRFbWl0dGVyPFJlYWNoRWRnZUV2ZW50PE5neEZsaWNraW5nQ29tcG9uZW50Pj47XG4gIEBPdXRwdXQoKSBwdWJsaWMgcGFuZWxDaGFuZ2U6IEV2ZW50RW1pdHRlcjxQYW5lbENoYW5nZUV2ZW50PE5neEZsaWNraW5nQ29tcG9uZW50Pj47XG5cbiAgQEhvc3RCaW5kaW5nKFwiY2xhc3MudmVydGljYWxcIikgcHVibGljIGdldCBpc1ZlcnRpY2FsKCkge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaG9yaXpvbnRhbCA9PT0gZmFsc2U7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoXCJjbGFzcy5mbGlja2luZy1oaWRkZW5cIikgcHVibGljIGdldCBpc0hpZGRlbkJlZm9yZUluaXQoKSB7XG4gICAgY29uc3QgaW5pdGlhbGl6ZWQgPSB0aGlzLl92YW5pbGxhRmxpY2tpbmcgJiYgdGhpcy5fdmFuaWxsYUZsaWNraW5nLmluaXRpYWxpemVkO1xuICAgIHJldHVybiB0aGlzLmhpZGVCZWZvcmVJbml0ICYmICFpbml0aWFsaXplZDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY2FtZXJhU3R5bGVCZWZvcmVJbml0KCkge1xuICAgIGNvbnN0IGluaXRpYWxpemVkID0gdGhpcy5fdmFuaWxsYUZsaWNraW5nICYmIHRoaXMuX3ZhbmlsbGFGbGlja2luZy5pbml0aWFsaXplZDtcbiAgICByZXR1cm4gIWluaXRpYWxpemVkICYmIHRoaXMuZmlyc3RQYW5lbFNpemVcbiAgICAgID8geyB0cmFuc2Zvcm06IGdldERlZmF1bHRDYW1lcmFUcmFuc2Zvcm0odGhpcy5vcHRpb25zLmFsaWduLCB0aGlzLm9wdGlvbnMuaG9yaXpvbnRhbCwgdGhpcy5maXJzdFBhbmVsU2l6ZSkgfVxuICAgICAgOiB7fTtcbiAgfVxuXG4gIEBDb250ZW50Q2hpbGRyZW4oTmd4RmxpY2tpbmdQYW5lbCkgcHJpdmF0ZSBfbmd4UGFuZWxzOiBRdWVyeUxpc3Q8Tmd4RmxpY2tpbmdQYW5lbD47XG4gIHByaXZhdGUgX3BsdWdpbnNEaWZmZXI6IExpc3REaWZmZXI8UGx1Z2luPiA9IG5ldyBMaXN0RGlmZmVyPFBsdWdpbj4oKTtcblxuICBwdWJsaWMgZ2V0IG5neFBhbmVscygpIHsgcmV0dXJuIHRoaXMuX25neFBhbmVsczsgfVxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uXG4gIHB1YmxpYyBnZXQgX2NhbWVyYUVsQ2xhc3MoKSB7IHJldHVybiBgZmxpY2tpbmctY2FtZXJhICR7dGhpcy5jYW1lcmFDbGFzcyA/PyBcIlwifWAudHJpbSgpOyB9XG5cbiAgcHJpdmF0ZSBfZGVzdHJveSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIF9lbFJlZjogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4sXG4gICAgcHJpdmF0ZSBfbmd4UmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIF9wbGF0Zm9ybUlkOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBfbmdab25lOiBOZ1pvbmUsXG4gICkge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLl92YW5pbGxhRmxpY2tpbmcgPSBudWxsO1xuXG4gICAgRVZFTlRfTkFNRVMuZm9yRWFjaChldnROYW1lID0+IHtcbiAgICAgIHRoaXNbZXZ0TmFtZV0gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGlmICghaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5fcGxhdGZvcm1JZCkpIHJldHVybjtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7XG4gICAgY29uc3Qgdmlld3BvcnRFbCA9IHRoaXMuX2VsUmVmLm5hdGl2ZUVsZW1lbnQ7XG4gICAgY29uc3QgdmlydHVhbCA9IG9wdGlvbnMudmlydHVhbCAmJiBvcHRpb25zLnBhbmVsc1BlclZpZXcgPiAwO1xuICAgIGNvbnN0IHJlbmRlcmVyT3B0aW9uczogTmd4UmVuZGVyZXJPcHRpb25zID0ge1xuICAgICAgbmd4RmxpY2tpbmc6IHRoaXMsXG4gICAgICBhbGlnbjogb3B0aW9ucy5hbGlnbixcbiAgICAgIG5neFJlbmRlcmVyOiB0aGlzLl9uZ3hSZW5kZXJlcixcbiAgICAgIHN0cmF0ZWd5OiB2aXJ0dWFsXG4gICAgICAgID8gbmV3IFZpcnR1YWxSZW5kZXJpbmdTdHJhdGVneSgpXG4gICAgICAgIDogbmV3IE5vcm1hbFJlbmRlcmluZ1N0cmF0ZWd5KHtcbiAgICAgICAgICBwcm92aWRlckN0b3I6IE5neEVsZW1lbnRQcm92aWRlclxuICAgICAgICB9KVxuICAgIH07XG5cbiAgICBpZiAodmlydHVhbCkge1xuICAgICAgdGhpcy5faW5pdFZpcnR1YWxFbGVtZW50cygpO1xuICAgIH1cblxuICAgIC8vIEluaXRpYWxpemUgYFZhbmlsbGFGbGlja2luZ2Agb3V0c2lkZSBvZiB0aGUgQW5ndWxhciB6b25lIHNvIGl0IHdpbGwgc2V0IHVwIGBtb3VzZWRvd25gXG4gICAgLy8gYW5kIGBtb3VzZW1vdmVgIGV2ZW50IGxpc3RlbmVycyB3aXRoaW4gdGhlIHJvb3Qgem9uZSwgYW5kIGl0IHdvbid0IHRyaWdnZXIgY2hhbmdlIGRldGVjdGlvblxuICAgIC8vIGV2ZXJ5IHRpbWUgdGhlIHVzZXIgbW92ZXMgdGhlIG1vdXNlLlxuICAgIGNvbnN0IGZsaWNraW5nID0gdGhpcy5fbmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IG5ldyBWYW5pbGxhRmxpY2tpbmcodmlld3BvcnRFbCwge1xuICAgICAgLi4udGhpcy5vcHRpb25zLFxuICAgICAgZXh0ZXJuYWxSZW5kZXJlcjogbmV3IE5neFJlbmRlcmVyKHJlbmRlcmVyT3B0aW9ucylcbiAgICB9KSk7XG4gICAgdGhpcy5fdmFuaWxsYUZsaWNraW5nID0gZmxpY2tpbmc7XG5cbiAgICBjb25zdCBlbGVtZW50RGlmZmVyID0gbmV3IExpc3REaWZmZXIodGhpcy5fbmd4UGFuZWxzLnRvQXJyYXkoKSk7XG5cbiAgICB0aGlzLl9iaW5kRXZlbnRzKCk7XG4gICAgdGhpcy5fY2hlY2tQbHVnaW5zKCk7XG5cbiAgICBpZiAodGhpcy5zdGF0dXMpIHtcbiAgICAgIGZsaWNraW5nLnNldFN0YXR1cyh0aGlzLnN0YXR1cyk7XG4gICAgfVxuXG4gICAgLy8gTm90ZTogZG9lc24ndCBuZWVkIHRvIHVuc3Vic2NyaWJlLCBiZWNhdXNlIGBjaGFuZ2VzYFxuICAgIC8vIGdldHMgY29tcGxldGVkIGJ5IEFuZ3VsYXIgd2hlbiB0aGUgdmlldyBpcyBkZXN0cm95ZWQuXG4gICAgdGhpcy5fbmd4UGFuZWxzLmNoYW5nZXMuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIGNvbnN0IHBhbmVscyA9IHRoaXMuX25neFBhbmVscy50b0FycmF5KCk7XG4gICAgICBjb25zdCBkaWZmUmVzdWx0ID0gZWxlbWVudERpZmZlci51cGRhdGUocGFuZWxzKTtcblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnVzZWQtdmFyc1xuICAgICAgc3luYyhmbGlja2luZywgZGlmZlJlc3VsdCwgWy4uLmRpZmZSZXN1bHQubWFpbnRhaW5lZC5tYXAoKFtfLCBpZHhdKSA9PiBkaWZmUmVzdWx0Lmxpc3RbaWR4XSksIC4uLmRpZmZSZXN1bHQuYWRkZWQubWFwKGlkeCA9PiBkaWZmUmVzdWx0Lmxpc3RbaWR4XSldKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLl9kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5fdmFuaWxsYUZsaWNraW5nPy5kZXN0cm95KCk7XG4gIH1cblxuICBwdWJsaWMgbmdPbkNoYW5nZXMoKSB7XG4gICAgY29uc3QgZmxpY2tpbmcgPSB0aGlzLl92YW5pbGxhRmxpY2tpbmc7XG4gICAgaWYgKCFmbGlja2luZykgcmV0dXJuO1xuXG4gICAgdGhpcy5fbmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHZvaWQgZmxpY2tpbmcucmVuZGVyZXIuZm9yY2VSZW5kZXJBbGxQYW5lbHMoKTtcbiAgICB9KTtcblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnNcbiAgICBjb25zdCB7IHZpcnR1YWwsIC4uLm5ld09wdGlvbnMgfSA9IHRoaXMub3B0aW9ucztcblxuICAgIC8vIE9taXQgJ3ZpcnR1YWwnLCBhcyBpdCBjYW4ndCBoYXZlIGFueSBzZXR0ZXJcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBuZXdPcHRpb25zKSB7XG4gICAgICBpZiAoa2V5IGluIGZsaWNraW5nICYmIGZsaWNraW5nW2tleV0gIT09IG5ld09wdGlvbnNba2V5XSkge1xuICAgICAgICBmbGlja2luZ1trZXldID0gbmV3T3B0aW9uc1trZXldO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuX2NoZWNrUGx1Z2lucygpO1xuICB9XG5cbiAgcHJpdmF0ZSBfYmluZEV2ZW50cygpIHtcbiAgICBjb25zdCBmbGlja2luZyA9IHRoaXMuX3ZhbmlsbGFGbGlja2luZyE7XG5cbiAgICBFVkVOVF9OQU1FUy5mb3JFYWNoKGV2dE5hbWUgPT4ge1xuICAgICAgLy8gYGZyb21FdmVudGAgc3VwcG9ydHMgcGFzc2luZyBgSlF1ZXJ5U3R5bGVFdmVudEVtaXR0ZXJgXG4gICAgICAvLyAoYW4gb2JqZWN0IHdpdGggYG9uYCBhbmQgYG9mZmAgbWV0aG9kcykuIGBmbGlja2luZ2AgYWN0cyBhcyBhXG4gICAgICAvLyBqUXVlcnkgZXZlbnQgZW1pdHRlciBzaW5jZSBpdCBoYXMgYm90aCBtZXRob2RzLlxuICAgICAgZnJvbUV2ZW50PENvbXBvbmVudEV2ZW50PihmbGlja2luZywgZXZ0TmFtZSlcbiAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSlcbiAgICAgICAgLnN1YnNjcmliZSgoZSkgPT4ge1xuICAgICAgICAgIC8vIFN0eWxlIGd1aWRlOiBFdmVudCAtIGh0dHBzOi8vYW5ndWxhci5pby9ndWlkZS9zdHlsZWd1aWRlI2RvbnQtcHJlZml4LW91dHB1dC1wcm9wZXJ0aWVzXG4gICAgICAgICAgY29uc3QgZW1pdHRlciA9IHRoaXNbZXZ0TmFtZV0gYXMgRXZlbnRFbWl0dGVyPEZsaWNraW5nRXZlbnRzW3R5cGVvZiBldnROYW1lXT47XG5cbiAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQgPSB0aGlzO1xuXG4gICAgICAgICAgaWYgKGVtaXR0ZXIgJiYgZW1pdHRlci5vYnNlcnZlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5fbmdab25lLnJ1bigoKSA9PiBlbWl0dGVyLmVtaXQoZSBhcyBGbGlja2luZ0V2ZW50c1t0eXBlb2YgZXZ0TmFtZV0pKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfY2hlY2tQbHVnaW5zKCkge1xuICAgIGNvbnN0IGZsaWNraW5nID0gdGhpcy5fdmFuaWxsYUZsaWNraW5nO1xuICAgIGlmICghZmxpY2tpbmcpIHJldHVybjtcblxuICAgIGNvbnN0IHsgbGlzdCwgYWRkZWQsIHJlbW92ZWQsIHByZXZMaXN0IH0gPSB0aGlzLl9wbHVnaW5zRGlmZmVyLnVwZGF0ZSh0aGlzLnBsdWdpbnMpO1xuXG4gICAgZmxpY2tpbmcuYWRkUGx1Z2lucyguLi5hZGRlZC5tYXAoaW5kZXggPT4gbGlzdFtpbmRleF0pKTtcbiAgICBmbGlja2luZy5yZW1vdmVQbHVnaW5zKC4uLnJlbW92ZWQubWFwKGluZGV4ID0+IHByZXZMaXN0W2luZGV4XSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfaW5pdFZpcnR1YWxFbGVtZW50cygpIHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5vcHRpb25zO1xuICAgIGNvbnN0IHJlbmRlcmVyID0gdGhpcy5fbmd4UmVuZGVyZXI7XG4gICAgY29uc3QgY2FtZXJhRWxlbWVudCA9IHRoaXMuX2VsUmVmLm5hdGl2ZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQ7XG4gICAgY29uc3QgcGFuZWxzUGVyVmlldyA9IG9wdGlvbnMucGFuZWxzUGVyVmlldyE7XG4gICAgY29uc3QgdmlydHVhbCA9IG9wdGlvbnMudmlydHVhbCE7XG4gICAgY29uc3QgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG5cbiAgICBjb25zdCBuZXdFbGVtZW50cyA9IHJhbmdlKHBhbmVsc1BlclZpZXcgKyAxKS5tYXAoaWR4ID0+IHtcbiAgICAgIGNvbnN0IHBhbmVsRWwgPSByZW5kZXJlci5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgcGFuZWxFbC5jbGFzc05hbWUgPSB2aXJ0dWFsLnBhbmVsQ2xhc3MgPz8gQ0xBU1MuREVGQVVMVF9WSVJUVUFMO1xuICAgICAgcGFuZWxFbC5kYXRhc2V0LmVsZW1lbnRJbmRleCA9IGlkeC50b1N0cmluZygpO1xuICAgICAgcmV0dXJuIHBhbmVsRWw7XG4gICAgfSk7XG5cbiAgICBuZXdFbGVtZW50cy5mb3JFYWNoKGVsID0+IHtcbiAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGVsKTtcbiAgICB9KTtcblxuICAgIHJlbmRlcmVyLmFwcGVuZENoaWxkKGNhbWVyYUVsZW1lbnQsIGZyYWdtZW50KTtcbiAgfVxufVxuIl19